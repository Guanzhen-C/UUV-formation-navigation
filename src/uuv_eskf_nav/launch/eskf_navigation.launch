<launch>
    <!--
    ESKF水下导航系统启动文件
    
    基于误差状态卡尔曼滤波(Error-State Kalman Filter)的水下载具导航系统
    
    功能特点:
    - 15维误差状态估计 (位置、速度、姿态、IMU偏差)
    - 融合IMU、DVL、深度传感器数据
    - 实时导航状态估计和协方差传播
    - 支持任意UUV载具 (只需修改robot_name参数)
    
    使用方法:
      # 使用默认载具 (eca_a9)
      roslaunch uuv_eskf_nav eskf_navigation.launch
      
      # 指定载具名称
      roslaunch uuv_eskf_nav eskf_navigation.launch robot_name:=rexrov2
      
      # 使用自定义配置文件
      roslaunch uuv_eskf_nav eskf_navigation.launch config_file:=/path/to/your/config.yaml
    -->
    
    <!-- ================================ -->
    <!-- 核心参数 -->
    <!-- ================================ -->
    
    <!-- 机器人名称 - 必须与仿真中的载具命名空间一致 -->
    <arg name="robot_name" default="eca_a9"/>
    
    <!-- 配置文件路径 -->
    <arg name="config_file" default="$(find uuv_eskf_nav)/config/eskf_params.yaml"/>
    
    <!-- 是否启用rviz可视化 -->
    <arg name="enable_rviz" default="false"/>
    
    <!-- 是否启用导航评估器 -->
    <arg name="enable_evaluator" default="true"/>
    
    <!-- ================================ -->
    <!-- 坐标系参数 -->  
    <!-- ================================ -->
    
    <!-- 世界坐标系名称 -->
    <arg name="world_frame" default="odom"/>
    
    <!-- 机器人基座坐标系名称 -->
    <arg name="base_link_frame" default="$(arg robot_name)/base_link"/>
    
    <!-- ================================ -->
    <!-- ESKF导航节点 -->
    <!-- ================================ -->
    
    <node pkg="uuv_eskf_nav" type="eskf_navigation_node" name="eskf_navigation" output="screen">
        <!-- 加载配置文件 -->
        <rosparam command="load" file="$(arg config_file)"/>
        
        <!-- 动态设置参数 (覆盖配置文件中的对应参数) -->
        <param name="robot_name" value="$(arg robot_name)"/>
        <param name="world_frame" value="$(arg world_frame)"/>
        <param name="base_link_frame" value="$(arg base_link_frame)"/>
        <!-- IMU线加速度是否包含重力：本环境设为false，由ESKF在传播端加g -->
        <param name="imu/accel_includes_gravity" value="false"/>
        
        <!-- 重映射话题 -->
        <remap from="/odometry/filtered" to="/eskf/odometry/filtered"/>
        <remap from="/eskf/pose" to="/eskf/pose"/>
    </node>
    
    <!-- ================================ -->
    <!-- 可选：导航评估器 -->
    <!-- ================================ -->
    
    <group if="$(arg enable_evaluator)">
        <node pkg="uuv_eskf_nav" type="navigation_evaluator.py" name="eskf_navigation_evaluator" output="screen">
            <param name="robot_name" value="$(arg robot_name)"/>
            <param name="filtered_odom_topic" value="/eskf/odometry/filtered"/>
            <param name="ground_truth_topic" value="/$(arg robot_name)/pose_gt"/>
        </node>
    </group>
    
    <!-- ================================ -->
    <!-- 可选：RViz可视化 -->
    <!-- ================================ -->
    
    <group if="$(arg enable_rviz)">
        <node name="rviz" pkg="rviz" type="rviz" 
              args="-d $(find uuv_eskf_nav)/config/eskf_visualization.rviz"
              output="screen" />
    </group>
    
    <!-- ================================ -->
    <!-- 信息显示 -->
    <!-- ================================ -->
    
    <node name="launch_info" pkg="rostopic" type="rostopic" 
          args="echo -n 1 /rosout" output="screen">
        <remap from="/rosout" to="/dev/null"/>
    </node>
    
    <!-- 在终端显示启动信息 -->
    <node name="startup_message" pkg="uuv_eskf_nav" type="startup_message.py" output="screen">
        <param name="robot_name" value="$(arg robot_name)"/>
        <param name="config_file" value="$(arg config_file)"/>
    </node>

</launch>
