<?xml version="1.0"?>
<launch>
  <!--
  启动仿真环境 + 生成 RexROV + 控制器

  使用方法:
    roslaunch rexrov_fgo_nav start_simulation.launch
    roslaunch uuv_control_utils start_circular_trajectory.launch uuv_name:=rexrov radius:=15 center_z:=-30

  自定义半径和深度:
    roslaunch rexrov_fgo_nav start_simulation.launch radius:=20 depth:=-40
    roslaunch uuv_control_utils start_circular_trajectory.launch uuv_name:=rexrov radius:=20 center_z:=-40

  UUV生成在圆周轨迹起点(radius, 0, depth)，朝向Y轴正方向（切线方向）
  -->

  <arg name="robot_name" default="rexrov"/>

  <!-- 圆周轨迹参数 -->
  <arg name="radius" default="15.0"/>
  <arg name="depth" default="-30.0"/>

  <!-- UUV初始位置：圆周起点，朝向切线方向 -->
  <arg name="x" default="$(arg radius)"/>
  <arg name="y" default="0.0"/>
  <arg name="z" default="$(arg depth)"/>
  <arg name="yaw" default="1.5708"/>  <!-- pi/2 = 90度，沿切线方向 -->

  <!-- 1. Start Simulation World -->
  <include file="$(find uuv_gazebo_worlds)/launch/ocean_waves.launch"/>

  <!-- 2. Spawn RexROV with Custom Sonar (Down-looking MBES) -->
  <group ns="$(arg robot_name)">
    <param name="robot_description"
           command="$(find xacro)/xacro '$(find rexrov_fgo_nav)/urdf/rexrov_sonar_custom.xacro' --inorder debug:=false namespace:=$(arg robot_name) inertial_reference_frame:=world" />

    <node name="urdf_spawner" pkg="uuv_descriptions" type="spawn_model" respawn="false" output="screen"
          args="-urdf -x $(arg x) -y $(arg y) -z $(arg z) -R 0 -P 0 -Y $(arg yaw) -model $(arg robot_name) -param /$(arg robot_name)/robot_description"/>

    <node name="robot_state_publisher" pkg="robot_state_publisher" type="robot_state_publisher" respawn="true" output="screen">
      <param name="robot_description" value="/$(arg robot_name)/robot_description" />
    </node>

    <!-- Publish static TF for DVL link relative to base_link -->
    <node pkg="tf" type="static_transform_publisher" name="$(arg robot_name)_base_link_to_dvl_link"
          args="-1.4 0 -0.312 0 1.5708 0 $(arg robot_name)/base_link $(arg robot_name)/dvl_link 100" />

    <!-- Bridge Sonar Optical Frame (Plugin ID -> URDF ID) -->
    <!-- The Gazebo plugin publishes 'forward_sonar_optical_frame' but URDF has 'rexrov/forward_sonar_optical_frame' -->
    <!-- Confirmed via tf_monitor: The URDF frame does NOT have '_mbes' suffix in this configuration -->
    <node pkg="tf" type="static_transform_publisher" name="sonar_frame_bridge"
          args="0 0 0 0 0 0 $(arg robot_name)/forward_sonar_optical_frame forward_sonar_optical_frame 100" />
  </group>

  <!-- 3. Start Controllers (Standard PID Trajectory Controller) -->
  <include file="$(find uuv_trajectory_control)/launch/rov_pid_controller.launch">
    <arg name="uuv_name" value="$(arg robot_name)"/>
    <arg name="model_name" value="rexrov"/>
  </include>

</launch>
